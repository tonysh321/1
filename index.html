<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户注册系统 - JSONP方案</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a00e0, #8e2de2);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .form {
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        .required::after {
            content: " *";
            color: #ff4757;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #4a00e0;
            box-shadow: 0 0 0 3px rgba(74, 0, 224, 0.1);
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4a00e0, #8e2de2);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a00e0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>用户注册系统</h1>
            <p>使用JSONP技术绕过CORS限制</p>
        </div>
        
        <form class="form" id="registerForm">
            <div class="form-group">
                <label class="required">后台账号</label>
                <input type="number" id="admin" placeholder="请输入后台账号 (数字)" required>
            </div>
            
            <div class="form-group">
                <label class="required">注册账号</label>
                <input type="number" id="user" placeholder="请输入注册账号 (数字)" required>
            </div>
            
            <div class="form-group">
                <label class="required">注册密码</label>
                <input type="password" id="password" placeholder="请输入密码" required>
            </div>
            
            <div class="form-group">
                <label class="required">注册昵称</label>
                <input type="text" id="name" placeholder="请输入昵称" required>
            </div>
            
            <div class="form-group">
                <label>注册验证码</label>
                <input type="number" id="code" placeholder="验证码 (可选)">
            </div>
            
            <div class="form-group">
                <label>邀请码</label>
                <input type="text" id="invite_code" placeholder="邀请码 (选填)">
            </div>
            
            <div class="form-group">
                <label>后台公钥</label>
                <input type="text" id="key" placeholder="公钥 (可选)">
            </div>
            
            <button type="submit">提交注册</button>
        </form>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>正在提交中...</p>
        </div>
        
        <div class="result" id="result"></div>
    </div>
    
    <!-- 隐藏的iframe用于提交 -->
    <iframe name="apiFrame" id="apiFrame" style="display:none;"></iframe>
    
    <script>
        // 全局回调函数
        window.jsonpCallback = function(data) {
            console.log('JSONP回调收到数据:', data);
            hideLoading();
            showResult(data);
            if (data.code === 1) {
                document.getElementById('registerForm').reset();
            }
        };
        
        // 页面加载完成
        window.onload = function() {
            const form = document.getElementById('registerForm');
            form.addEventListener('submit', handleSubmit);
            
            // 为iframe添加事件监听
            document.getElementById('apiFrame').onload = function() {
                console.log('iframe加载完成');
                // 尝试从iframe获取数据
                try {
                    const iframe = document.getElementById('apiFrame');
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const bodyText = iframeDoc.body.innerText;
                    
                    if (bodyText) {
                        try {
                            const data = JSON.parse(bodyText);
                            hideLoading();
                            showResult(data);
                            if (data.code === 1) {
                                document.getElementById('registerForm').reset();
                            }
                        } catch (e) {
                            console.log('无法解析iframe响应:', bodyText);
                        }
                    }
                } catch (e) {
                    console.log('无法访问iframe内容');
                }
            };
        };
        
        // 处理提交
        function handleSubmit(event) {
            event.preventDefault();
            
            // 显示加载
            showLoading('正在提交注册信息...');
            
            // 收集数据
            const formData = {
                admin: document.getElementById('admin').value,
                user: document.getElementById('user').value,
                password: document.getElementById('password').value,
                name: document.getElementById('name').value,
                code: document.getElementById('code').value || '',
                invite_code: document.getElementById('invite_code').value || '',
                key: document.getElementById('key').value || ''
            };
            
            // 验证
            if (!validateForm(formData)) {
                hideLoading();
                return;
            }
            
            // 尝试多种方法
            trySubmit(formData);
        }
        
        // 验证表单
        function validateForm(data) {
            const errors = [];
            
            if (!data.admin) errors.push('后台账号不能为空');
            if (!data.user) errors.push('注册账号不能为空');
            if (!data.password) errors.push('密码不能为空');
            if (!data.name) errors.push('昵称不能为空');
            
            if (data.admin && isNaN(data.admin)) errors.push('后台账号必须是数字');
            if (data.user && isNaN(data.user)) errors.push('注册账号必须是数字');
            if (data.code && data.code !== '' && isNaN(data.code)) errors.push('验证码必须是数字');
            
            if (errors.length > 0) {
                showError(errors.join('<br>'));
                return false;
            }
            
            return true;
        }
        
        // 尝试多种提交方法
        function trySubmit(formData) {
            // 方法1：JSONP（如果API支持）
            console.log('尝试JSONP方法...');
            submitViaJSONP(formData);
            
            // 方法2：iframe方式（备用）
            setTimeout(() => {
                if (document.getElementById('loading').style.display !== 'none') {
                    console.log('JSONP超时，尝试iframe方法...');
                    submitViaIframe(formData);
                }
            }, 3000);
        }
        
        // JSONP方式提交
        function submitViaJSONP(formData) {
            try {
                // 构建查询参数
                const params = new URLSearchParams();
                params.append('admin', formData.admin);
                params.append('user', formData.user);
                params.append('password', formData.password);
                params.append('name', formData.name);
                if (formData.code) params.append('code', formData.code);
                if (formData.invite_code) params.append('invite_code', formData.invite_code);
                if (formData.key) params.append('key', formData.key);
                
                // 添加callback参数
                params.append('callback', 'jsonpCallback');
                
                // 创建script标签
                const script = document.createElement('script');
                script.src = `http://a.buhui.ltd/main/backend/user/Register.php?${params.toString()}`;
                
                // 设置超时
                const timeoutId = setTimeout(() => {
                    document.body.removeChild(script);
                    console.log('JSONP请求超时');
                }, 5000);
                
                // 加载完成或出错时清理
                script.onload = script.onerror = function() {
                    clearTimeout(timeoutId);
                    if (this.parentNode) {
                        this.parentNode.removeChild(this);
                    }
                };
                
                // 添加到页面
                document.body.appendChild(script);
                
            } catch (error) {
                console.log('JSONP请求失败:', error);
            }
        }
        
        // iframe方式提交
        function submitViaIframe(formData) {
            try {
                // 创建隐藏的form
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'http://a.buhui.ltd/main/backend/user/Register.php';
                form.target = 'apiFrame';
                form.style.display = 'none';
                
                // 添加input字段
                for (const key in formData) {
                    if (formData[key] !== '') {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = formData[key];
                        form.appendChild(input);
                    }
                }
                
                // 添加到body并提交
                document.body.appendChild(form);
                form.submit();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(form);
                }, 1000);
                
            } catch (error) {
                console.log('iframe方式失败:', error);
                showError('提交失败，请直接访问API页面');
            }
        }
        
        // 显示加载
        function showLoading(message) {
            const loading = document.getElementById('loading');
            loading.querySelector('p').textContent = message;
            loading.style.display = 'block';
            document.getElementById('result').innerHTML = '';
        }
        
        // 隐藏加载
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // 显示结果
        function showResult(data) {
            const result = document.getElementById('result');
            const isSuccess = data.code === 1;
            const time = new Date().toLocaleString();
            
            result.innerHTML = `
                <div class="${isSuccess ? 'success' : 'error'}">
                    <strong>${isSuccess ? '✅ 注册成功' : '❌ 注册失败'}</strong><br>
                    状态码: ${data.code}<br>
                    消息: ${data.msg || '无消息'}<br>
                    时间: ${time}
                </div>
            `;
            
            result.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 显示错误
        function showError(message) {
            const result = document.getElementById('result');
            result.innerHTML = `
                <div class="error">
                    <strong>⚠️ 错误</strong><br>
                    ${message}<br><br>
                    <small>如果持续失败，请尝试：<br>
                    1. 直接访问API接口<br>
                    2. 联系管理员确认API状态<br>
                    3. 检查输入信息是否正确</small>
                </div>
            `;
            
            result.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
