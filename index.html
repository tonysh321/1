<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户注册系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .form {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        label i {
            margin-right: 8px;
            color: #667eea;
        }
        
        .required::after {
            content: " *";
            color: #ff4757;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4361ee;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .response {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .response.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .response.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .method-selector {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .method-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .method-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .method-btn {
            flex: 1;
            padding: 10px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .method-btn.active {
            background: #4361ee;
            color: white;
            border-color: #4361ee;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-online {
            color: #28a745;
        }
        
        .status-offline {
            color: #dc3545;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .form {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1><i class="fas fa-user-plus"></i> 用户注册系统</h1>
                <p>安全、快速、便捷的用户注册</p>
            </div>
            
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="status-item">
                    <i class="fas fa-globe"></i>
                    <span>目标API:</span>
                    <span class="status-offline" id="apiStatus">检测中...</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-bolt"></i>
                    <span>连接方式:</span>
                    <span id="connectionMethod">自动选择</span>
                </div>
            </div>
            
            <!-- 方法选择器 -->
            <div class="method-selector">
                <div class="method-label">
                    <i class="fas fa-cogs"></i> 选择连接方式:
                </div>
                <div class="method-options">
                    <div class="method-btn active" data-method="auto">
                        <i class="fas fa-magic"></i> 自动选择
                    </div>
                    <div class="method-btn" data-method="direct">
                        <i class="fas fa-directions"></i> 直接连接
                    </div>
                    <div class="method-btn" data-method="proxy1">
                        <i class="fas fa-shield-alt"></i> 代理1
                    </div>
                    <div class="method-btn" data-method="proxy2">
                        <i class="fas fa-sync-alt"></i> 代理2
                    </div>
                </div>
            </div>
            
            <!-- 注册表单 -->
            <form class="form" id="registerForm">
                <div class="form-group">
                    <label class="required" for="admin">
                        <i class="fas fa-user-shield"></i> 后台账号
                    </label>
                    <input type="number" id="admin" name="admin" placeholder="请输入后台账号 (数字)" required>
                </div>
                
                <div class="form-group">
                    <label class="required" for="user">
                        <i class="fas fa-user"></i> 注册账号
                    </label>
                    <input type="number" id="user" name="user" placeholder="请输入注册账号 (数字)" required>
                </div>
                
                <div class="form-group">
                    <label class="required" for="password">
                        <i class="fas fa-lock"></i> 注册密码
                    </label>
                    <input type="password" id="password" name="password" placeholder="请输入密码" required>
                </div>
                
                <div class="form-group">
                    <label class="required" for="name">
                        <i class="fas fa-signature"></i> 注册昵称
                    </label>
                    <input type="text" id="name" name="name" placeholder="请输入昵称" required>
                </div>
                
                <div class="form-group">
                    <label for="code">
                        <i class="fas fa-shield-alt"></i> 注册验证码
                    </label>
                    <input type="number" id="code" name="code" placeholder="请输入验证码 (如未开启可不填)">
                    <div class="form-hint">
                        <i class="fas fa-info-circle"></i> 未开启验证码注册不需要填写
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="invite_code">
                        <i class="fas fa-gift"></i> 邀请码
                    </label>
                    <input type="text" id="invite_code" name="invite_code" placeholder="请输入邀请码 (选填)">
                </div>
                
                <div class="form-group">
                    <label for="key">
                        <i class="fas fa-key"></i> 后台公钥
                    </label>
                    <input type="text" id="key" name="key" placeholder="请输入公钥">
                    <div class="form-hint">
                        <i class="fas fa-info-circle"></i> 未开启公钥或已开启请求接口加密则不需要填
                    </div>
                </div>
                
                <button type="submit" class="btn-submit">
                    <i class="fas fa-paper-plane"></i> 提交注册
                </button>
            </form>
            
            <!-- 加载动画 -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">正在提交注册信息...</p>
            </div>
            
            <!-- 响应区域 -->
            <div class="response" id="response"></div>
        </div>
    </div>
    
    <!-- 不需要任何外部依赖的JavaScript -->
    <script>
        // 配置
        const CONFIG = {
            // 目标API地址
            TARGET_API: 'http://a.buhui.ltd/main/backend/user/Register.php',
            
            // 各种代理服务
            PROXY_SERVICES: {
                // CORS代理1：corsproxy.io（当前可用）
                proxy1: {
                    name: 'CORS代理1',
                    url: 'https://corsproxy.io/?',
                    method: 'full',
                    timeout: 15000
                },
                
                // CORS代理2：allorigins
                proxy2: {
                    name: 'CORS代理2',
                    url: 'https://api.allorigins.win/raw?url=',
                    method: 'simple',
                    timeout: 15000
                },
                
                // 直接连接（如果API支持CORS）
                direct: {
                    name: '直接连接',
                    url: '',
                    method: 'direct',
                    timeout: 10000
                }
            },
            
            // 超时时间（毫秒）
            TIMEOUT: 20000
        };
        
        // 当前选中的方法
        let currentMethod = 'auto';
        
        // DOM元素
        const elements = {
            form: document.getElementById('registerForm'),
            loading: document.getElementById('loading'),
            loadingText: document.getElementById('loadingText'),
            response: document.getElementById('response'),
            apiStatus: document.getElementById('apiStatus'),
            connectionMethod: document.getElementById('connectionMethod')
        };
        
        // 方法选择按钮
        const methodButtons = document.querySelectorAll('.method-btn');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        function initApp() {
            // 绑定事件
            bindEvents();
            
            // 检查API状态
            checkAPIStatus();
        }
        
        function bindEvents() {
            // 表单提交
            elements.form.addEventListener('submit', handleSubmit);
            
            // 方法选择
            methodButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有active类
                    methodButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // 添加active类到当前按钮
                    this.classList.add('active');
                    
                    // 更新当前方法
                    currentMethod = this.dataset.method;
                    
                    // 更新状态显示
                    if (currentMethod === 'auto') {
                        elements.connectionMethod.textContent = '自动选择';
                    } else if (currentMethod === 'direct') {
                        elements.connectionMethod.textContent = '直接连接';
                    } else {
                        elements.connectionMethod.textContent = CONFIG.PROXY_SERVICES[currentMethod]?.name || '代理';
                    }
                });
            });
        }
        
        // 检查API状态
        async function checkAPIStatus() {
            try {
                // 使用最简单的检查方式
                const testData = {
                    admin: 3855584220,
                    user: 123456,
                    password: 'test123',
                    name: '测试用户'
                };
                
                // 尝试使用第一个代理
                const proxy = CONFIG.PROXY_SERVICES.proxy1;
                const encodedUrl = encodeURIComponent(CONFIG.TARGET_API);
                const testUrl = `${proxy.url}${encodedUrl}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams(testData).toString(),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    elements.apiStatus.textContent = '在线';
                    elements.apiStatus.className = 'status-online';
                } else {
                    elements.apiStatus.textContent = '响应错误';
                    elements.apiStatus.className = 'status-offline';
                }
            } catch (error) {
                console.log('API状态检查失败:', error.message);
                elements.apiStatus.textContent = '离线';
                elements.apiStatus.className = 'status-offline';
            }
        }
        
        // 处理表单提交
        async function handleSubmit(event) {
            event.preventDefault();
            
            // 收集表单数据
            const formData = getFormData();
            
            // 验证表单
            if (!validateForm(formData)) {
                return;
            }
            
            // 显示加载
            showLoading('正在提交注册信息...');
            
            // 清空之前的响应
            clearResponse();
            
            try {
                // 根据选择的方法发送请求
                let result;
                if (currentMethod === 'auto') {
                    result = await sendWithAutoRetry(formData);
                } else if (currentMethod === 'direct') {
                    result = await sendDirect(formData);
                } else {
                    result = await sendWithProxy(formData, currentMethod);
                }
                
                // 处理结果
                handleResult(result);
                
                // 如果成功，清空表单
                if (result.code === 1) {
                    setTimeout(() => {
                        elements.form.reset();
                        showSuccessMessage('注册成功！表单已重置。');
                    }, 1500);
                }
                
            } catch (error) {
                console.error('提交失败:', error);
                showError(`提交失败: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        // 收集表单数据
        function getFormData() {
            const formData = new FormData(elements.form);
            const data = Object.fromEntries(formData.entries());
            
            // 清理数据
            Object.keys(data).forEach(key => {
                if (typeof data[key] === 'string') {
                    data[key] = data[key].trim();
                }
            });
            
            return data;
        }
        
        // 验证表单
        function validateForm(data) {
            const errors = [];
            
            // 检查必填字段
            if (!data.admin) errors.push('后台账号不能为空');
            if (!data.user) errors.push('注册账号不能为空');
            if (!data.password) errors.push('密码不能为空');
            if (!data.name) errors.push('昵称不能为空');
            
            // 检查数字类型
            if (data.admin && isNaN(data.admin)) errors.push('后台账号必须是数字');
            if (data.user && isNaN(data.user)) errors.push('注册账号必须是数字');
            if (data.code && data.code !== '' && isNaN(data.code)) errors.push('验证码必须是数字');
            
            // 检查密码长度
            if (data.password && data.password.length < 6) {
                errors.push('密码长度不能少于6位');
            }
            
            // 显示错误
            if (errors.length > 0) {
                showError(errors.join('<br>'));
                return false;
            }
            
            return true;
        }
        
        // 自动重试所有方法
        async function sendWithAutoRetry(data) {
            const methods = ['proxy1', 'proxy2', 'direct'];
            
            for (const method of methods) {
                try {
                    console.log(`尝试方法: ${method}`);
                    
                    let result;
                    if (method === 'direct') {
                        result = await sendDirect(data);
                    } else {
                        result = await sendWithProxy(data, method);
                    }
                    
                    // 更新连接方式显示
                    elements.connectionMethod.textContent = CONFIG.PROXY_SERVICES[method]?.name || '直接连接';
                    
                    return result;
                    
                } catch (error) {
                    console.log(`方法 ${method} 失败:`, error.message);
                    continue;
                }
            }
            
            throw new Error('所有连接方法都失败，请检查网络连接');
        }
        
        // 直接发送请求
        async function sendDirect(data) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
            
            try {
                const formData = new URLSearchParams(data);
                
                const response = await fetch(CONFIG.TARGET_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData.toString(),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    throw new Error('请求超时，请稍后重试');
                }
                
                if (error.message.includes('CORS')) {
                    throw new Error('API不支持跨域请求，请使用代理方法');
                }
                
                throw error;
            }
        }
        
        // 使用代理发送请求
        async function sendWithProxy(data, proxyKey) {
            const proxy = CONFIG.PROXY_SERVICES[proxyKey];
            if (!proxy) {
                throw new Error('代理配置不存在');
            }
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), proxy.timeout);
            
            try {
                const formData = new URLSearchParams(data);
                
                let requestUrl;
                let requestBody;
                let requestHeaders;
                
                // 根据代理类型构建请求
                if (proxy.method === 'full') {
                    // 完整代理方式
                    const fullUrl = `${CONFIG.TARGET_API}?${formData.toString()}`;
                    requestUrl = `${proxy.url}${encodeURIComponent(fullUrl)}`;
                    requestBody = null;
                    requestHeaders = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    };
                } else {
                    // 简单代理方式
                    requestUrl = `${proxy.url}${encodeURIComponent(CONFIG.TARGET_API)}`;
                    requestBody = formData.toString();
                    requestHeaders = {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    };
                }
                
                // 发送请求
                const response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: requestHeaders,
                    body: requestBody,
                    signal: controller.signal,
                    mode: 'cors'
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`代理请求失败: ${response.status} ${response.statusText}`);
                }
                
                // 解析响应
                let result;
                if (proxyKey === 'proxy2') {
                    // allorigins.win 返回的是包裹的数据
                    const wrapper = await response.json();
                    if (wrapper.contents) {
                        result = JSON.parse(wrapper.contents);
                    } else {
                        result = wrapper;
                    }
                } else {
                    result = await response.json();
                }
                
                return result;
                
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    throw new Error(`代理请求超时（${proxy.name}）`);
                }
                
                throw new Error(`${proxy.name}失败: ${error.message}`);
            }
        }
        
        // 处理结果
        function handleResult(result) {
            const timestamp = new Date().toLocaleString();
            const isSuccess = result.code === 1;
            
            const responseHTML = `
                <h3 style="margin-bottom: 15px;">
                    <i class="fas ${isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    ${isSuccess ? '注册成功' : '注册失败'}
                </h3>
                <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 6px; font-family: monospace;">
                    <strong>状态码:</strong> ${result.code}<br>
                    <strong>消息:</strong> ${result.msg}<br>
                    <strong>时间:</strong> ${timestamp}
                </div>
            `;
            
            showResponse(responseHTML, isSuccess ? 'success' : 'error');
            
            // 滚动到响应区域
            elements.response.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 显示响应
        function showResponse(content, type) {
            elements.response.innerHTML = content;
            elements.response.className = `response ${type}`;
            elements.response.style.display = 'block';
        }
        
        // 显示成功消息
        function showSuccessMessage(message) {
            const html = `
                <h3 style="margin-bottom: 10px; color: #155724;">
                    <i class="fas fa-check-circle"></i> 操作成功
                </h3>
                <p>${message}</p>
            `;
            showResponse(html, 'success');
        }
        
        // 显示错误
        function showError(message) {
            const html = `
                <h3 style="margin-bottom: 10px; color: #721c24;">
                    <i class="fas fa-exclamation-triangle"></i> 错误
                </h3>
                <p>${message}</p>
                <hr style="margin: 15px 0; border-color: #f5c6cb;">
                <div style="font-size: 14px; color: #666;">
                    <strong>建议:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>检查网络连接</li>
                        <li>尝试切换连接方式</li>
                        <li>确认输入信息正确</li>
                        <li>刷新页面重试</li>
                    </ul>
                </div>
            `;
            showResponse(html, 'error');
        }
        
        // 清空响应
        function clearResponse() {
            elements.response.innerHTML = '';
            elements.response.style.display = 'none';
        }
        
        // 显示加载
        function showLoading(message) {
            elements.loadingText.textContent = message;
            elements.loading.style.display = 'block';
        }
        
        // 隐藏加载
        function hideLoading() {
            elements.loading.style.display = 'none';
        }
    </script>
</body>
</html>
